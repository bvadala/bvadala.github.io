(()=>{"use strict";const n={maxVotes:3,useRankedVoting:!1};function t(t){return t.get("board","shared","settings",n)}var e=function(n,t,e,i){return new(e||(e=Promise))((function(o,r){function c(n){try{l(i.next(n))}catch(n){r(n)}}function u(n){try{l(i.throw(n))}catch(n){r(n)}}function l(n){var t;n.done?o(n.value):(t=n.value,t instanceof e?t:new e((function(n){n(t)}))).then(c,u)}l((i=i.apply(n,t||[])).next())}))};const i="votes",o="voting_locked";function r(n,t){return n.get(t||"card","shared",i,[])}function c(n){return e(this,void 0,void 0,(function*(){const t=yield r(n);if(!t)return!1;const e=yield n.member("id");return t.includes(e.id)}))}function u(n){return e(this,void 0,void 0,(function*(){return l(n)}))}function l(n){return n.get("board","shared",o,!1)}var a=function(n,t,e,i){return new(e||(e=Promise))((function(o,r){function c(n){try{l(i.next(n))}catch(n){r(n)}}function u(n){try{l(i.throw(n))}catch(n){r(n)}}function l(n){var t;n.done?o(n.value):(t=n.value,t instanceof e?t:new e((function(n){n(t)}))).then(c,u)}l((i=i.apply(n,t||[])).next())}))};function d(n,o){return a(this,void 0,void 0,(function*(){if((yield t(n)).useRankedVoting)return[];const l=yield function(n){return e(this,void 0,void 0,(function*(){if(yield u(n))return{canVote:!1,errorMsg:"Voting Locked"};if(!n.memberCanWriteToModel("card")||!n.isMemberSignedIn())return{canVote:!1,errorMsg:"Not a member"};if(yield c(n))return{canVote:!0};const i=(yield n.list("id","cards")).cards.map((n=>n.id)),o=yield function(n,t){return e(this,void 0,void 0,(function*(){return(yield Promise.all(t.map((t=>e(this,void 0,void 0,(function*(){const e=yield r(n,t);if(!e)return 0;const i=n.getContext().member;return e.includes(i)?1:0})))))).reduce(((n,t)=>n+t),0)}))}(n,i),l=o<(yield t(n)).maxVotes;return{canVote:l,errorMsg:l?null:"Too many votes"}}))}(n);return l.canVote?[{icon:o.images.thumbsUp,text:(yield c(n))?"Vote ☑":"Vote ☐",callback:function(n){return a(this,void 0,void 0,(function*(){yield function(n){return e(this,void 0,void 0,(function*(){const t=yield r(n),e=yield n.member("id"),o=t.indexOf(e.id,0);return o>=0?t.splice(o,1):t.push(e.id),yield n.set("card","shared",i,t),!0}))}(n)}))}}]:(console.log(l.errorMsg),[])}))}function s(n){return t=this,e=void 0,o=function*(){const t=yield n.member("id"),e=(yield n.board("id","memberships")).memberships.find((n=>n.idMember===t.id));return!!e&&"admin"==e.memberType},new((i=void 0)||(i=Promise))((function(n,r){function c(n){try{l(o.next(n))}catch(n){r(n)}}function u(n){try{l(o.throw(n))}catch(n){r(n)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(n){n(e)}))).then(c,u)}l((o=o.apply(t,e||[])).next())}));var t,e,i,o}function f(n,t){return i=this,r=void 0,a=function*(){if(!(yield s(n)))return[];const i=yield u(n);return[{text:i?"Unlock Voting":"Lock Voting",icon:{dark:i?t.images.lockedWhite:t.images.unlockedWhite,light:i?t.images.lockedBlack:t.images.unlockedWhite},callback:function(n){return function(n){return e(this,void 0,void 0,(function*(){const t=yield l(n);yield n.set("board","shared",o,!t)}))}(n)}}]},new((c=void 0)||(c=Promise))((function(n,t){function e(n){try{u(a.next(n))}catch(n){t(n)}}function o(n){try{u(a.throw(n))}catch(n){t(n)}}function u(t){var i;t.done?n(t.value):(i=t.value,i instanceof c?i:new c((function(n){n(i)}))).then(e,o)}u((a=a.apply(i,r||[])).next())}));var i,r,c,a}var h=function(n,t,e,i){return new(e||(e=Promise))((function(o,r){function c(n){try{l(i.next(n))}catch(n){r(n)}}function u(n){try{l(i.throw(n))}catch(n){r(n)}}function l(n){var t;n.done?o(n.value):(t=n.value,t instanceof e?t:new e((function(n){n(t)}))).then(c,u)}l((i=i.apply(n,t||[])).next())}))};const v=window.location.href.replace(/\/$/,""),m={baseUrl:v,images:{thumbsUp:`${v}/images/thumbs_up.svg`,thumbsUpWhite:`${v}/images/thumbs_up_white.svg`,lockedBlack:`${v}/images/locked-black.png`,lockedWhite:`${v}/images/locked-white.png`,unlockedBlack:`${v}/images/unlocked-black.png`,unlockedWhite:`${v}/images/unlocked-white.png`}};window.TrelloPowerUp.initialize({"card-buttons":n=>d(n,m),"show-settings":n=>function(n){return t=this,e=void 0,o=function*(){return(yield s(n))?n.popup({title:"ShipIt Voting - Settings",url:"settings.html"}):null},new((i=void 0)||(i=Promise))((function(n,r){function c(n){try{l(o.next(n))}catch(n){r(n)}}function u(n){try{l(o.throw(n))}catch(n){r(n)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(n){n(e)}))).then(c,u)}l((o=o.apply(t,e||[])).next())}));var t,e,i,o}(n),"card-detail-badges":n=>function(n){return e=this,i=void 0,u=function*(){if((yield t(n)).useRankedVoting)return[];const e=yield c(n);if(yield s(n)){const t=yield r(n);if(!t.length)return null;let i=t.length.toString();return e&&(i+=" (including yours)"),[{text:i,color:e?"blue":null}]}return e?[{text:"Voted",color:e?"blue":null}]:null},new((o=void 0)||(o=Promise))((function(n,t){function r(n){try{l(u.next(n))}catch(n){t(n)}}function c(n){try{l(u.throw(n))}catch(n){t(n)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o((function(n){n(e)}))).then(r,c)}l((u=u.apply(e,i||[])).next())}));var e,i,o,u}(n),"card-badges":n=>function(n,e){return i=this,o=void 0,l=function*(){if((yield t(n)).useRankedVoting)return[];const i=yield c(n);if(yield s(n)){const t=yield r(n);return t.length?[{text:t.length.toString(),color:i?"blue":null,icon:i?e.images.thumbsUpWhite:e.images.thumbsUp}]:null}return i?[{text:"",color:i?"blue":null,icon:e.images.thumbsUpWhite}]:null},new((u=void 0)||(u=Promise))((function(n,t){function e(n){try{c(l.next(n))}catch(n){t(n)}}function r(n){try{c(l.throw(n))}catch(n){t(n)}}function c(t){var i;t.done?n(t.value):(i=t.value,i instanceof u?i:new u((function(n){n(i)}))).then(e,r)}c((l=l.apply(i,o||[])).next())}));var i,o,u,l}(n,m),"list-actions":n=>function(n){return e=this,i=void 0,r=function*(){var e=[];return(yield t(n)).useRankedVoting&&e.push({text:"Vote",callback:function(t){return n.modal({url:"rankedVoting.html",title:"Ranked Voting"})}}),(yield s(n))&&e.push({text:"Podium Reveal",callback:function(t){return n.modal({url:"reveal.html",fullscreen:!0,title:"Podium Reveal"})}}),e},new((o=void 0)||(o=Promise))((function(n,t){function c(n){try{l(r.next(n))}catch(n){t(n)}}function u(n){try{l(r.throw(n))}catch(n){t(n)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o((function(n){n(e)}))).then(c,u)}l((r=r.apply(e,i||[])).next())}));var e,i,o,r}(n),"board-buttons":n=>f(n,m),"list-sorters":n=>function(n){return h(this,void 0,void 0,(function*(){return(yield s(n))?[{text:"Most Votes",callback:function(n,t){return h(this,void 0,void 0,(function*(){const i=yield function(n,t){return e(this,void 0,void 0,(function*(){if(!t){const e=yield n.list("id","cards");t=e.cards}let e=[];for(const i of t)e.push({id:i.id,title:i.name,votes:(yield r(n,i.id)).length});return e.sort(((n,t)=>n.votes>t.votes?-1:1))}))}(n,t.cards);return console.log(JSON.stringify(i)),{sortedIds:i.map((n=>n.id))}}))}}]:[]}))}(n)},{helpfulStacks:!0})})();